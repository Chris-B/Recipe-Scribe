FROM node:22-bookworm-slim

# Basic tooling
RUN corepack enable

# pnpm store path (so it's cacheable)
ENV PNPM_HOME=/pnpm
ENV PATH=$PNPM_HOME:$PATH
ENV PNPM_STORE_DIR=/pnpm/store

WORKDIR /app

# Copy only lockfiles first for better caching
COPY pnpm-lock.yaml package.json pnpm-workspace.yaml tsconfig.base.json ./

# If you have per-package package.json files, copy them too for cache:
COPY apps/api/package.json apps/api/package.json
COPY apps/web/package.json apps/web/package.json
COPY packages/shared/package.json packages/shared/package.json

# Install deps (cached via pnpm_store volume in compose)
RUN pnpm install

# Now copy the rest
COPY . .

# Expose dev ports (optional)
EXPOSE 5173 8787